<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>First-Person Roguelike</title>
  <style>
    body { background:#000; color:#0f0; font-family:monospace; }
    #game { display:flex; }
    canvas { border:1px solid #0f0; }
    #log { height:200px; overflow:auto; border:1px solid #0f0; padding:4px; }
    #controls { margin-left:10px; width:220px; }
    .bar-container {
      width: 100%; height: 16px; background: #222; border: 1px solid #0f0; margin: 4px 0;
    }
    .bar { height: 100%; }
    .hp { background: red; }
    .mp { background: blue; }
  </style>
</head>
<body>
  <h1>First-Person Roguelike</h1>
  <div id="game">
    <canvas id="canvas" width="640" height="480"></canvas>
    <div id="controls">
      <button onclick="newGame()">New Game</button><br>
      <div>HP</div>
      <div class="bar-container"><div id="hp-bar" class="bar hp"></div></div>
      <div>Mana</div>
      <div class="bar-container"><div id="mp-bar" class="bar mp"></div></div>
      <pre id="stats"></pre>
      <div id="inventory"></div>
      <div id="log"></div>
    </div>
  </div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const MAP_W=20, MAP_H=20;

let state={};

function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}

function newGame(seed){
  state = {};
  state.seed = seed || Math.floor(Math.random()*1e9);
  state.rng = mulberry32(state.seed);
  state.map = generateMap();
  state.enemies = [];
  state.items = [];
  state.turn = 0;
  state.player = {
    x: 2, y: 2,
    hp: 20, maxHp: 20,
    mp: 10, maxMp: 10,
    dir: 0,
    poison: 0,
    inventory: { health: 0, mana: 0 }
  };
  spawnStuff();
  pushMessage("Welcome to the dungeon!");
  draw();
}

function generateMap(){
  let map=[];
  for(let y=0;y<MAP_H;y++){
    let row=[];
    for(let x=0;x<MAP_W;x++){
      if(x===0||y===0||x===MAP_W-1||y===MAP_H-1) row.push("#");
      else row.push(".");
    }
    map.push(row);
  }
  for(let i=0;i<40;i++){
    let x=Math.floor(Math.random()*(MAP_W-2))+1;
    let y=Math.floor(Math.random()*(MAP_H-2))+1;
    map[y][x]="#";
  }
  return map;
}

function spawnStuff(){
  for(let i=0;i<5;i++){
    let x=Math.floor(Math.random()*(MAP_W-2))+1;
    let y=Math.floor(Math.random()*(MAP_H-2))+1;
    if(state.map[y][x]===".") state.enemies.push({x,y,hp:8,name:"goblin"});
  }
  for(let i=0;i<6;i++){
    let x=Math.floor(Math.random()*(MAP_W-2))+1;
    let y=Math.floor(Math.random()*(MAP_H-2))+1;
    if(state.map[y][x]==="."){
      let type = state.rng() < 0.5 ? "potion" : "mana";
      state.items.push({x,y,type});
    }
  }
}

function pushMessage(msg){
  const log=document.getElementById("log");
  log.innerHTML=msg+"<br>"+log.innerHTML;
}

function dirToDelta(dir){
  if(dir===0) return [0,-1];
  if(dir===1) return [1,0];
  if(dir===2) return [0,1];
  if(dir===3) return [-1,0];
}

// ==== INVENTORY ====
function useHealthPotion(){
  if(state.player.inventory.health > 0){
    state.player.inventory.health--;
    state.player.hp = Math.min(state.player.maxHp, state.player.hp+8);
    pushMessage("You drink a health potion (+8 HP).");
    enemiesTurn();
  } else {
    pushMessage("No health potions!");
  }
}

function useManaPotion(){
  if(state.player.inventory.mana > 0){
    state.player.inventory.mana--;
    state.player.mp = Math.min(state.player.maxMp, state.player.mp+5);
    pushMessage("You drink a mana potion (+5 MP).");
    enemiesTurn();
  } else {
    pushMessage("No mana potions!");
  }
}

// ==== ENEMY TURN ====
function enemiesTurn(){
  for(let e of state.enemies){
    if(Math.abs(e.x-state.player.x)+Math.abs(e.y-state.player.y) > 2 && state.rng()<0.5){
      const dir = Math.floor(state.rng()*4);
      const [dx,dy] = dirToDelta(dir);
      const nx=e.x+dx, ny=e.y+dy;
      if(state.map[ny][nx]==='.' && !(nx===state.player.x&&ny===state.player.y)){
        e.x=nx; e.y=ny;
      }
    }
    if(Math.abs(e.x-state.player.x)+Math.abs(e.y-state.player.y)===1){
      let roll = state.rng();
      if(roll < 0.2){
        state.player.hp -= 4;
        pushMessage(`The ${e.name} performs a heavy swing! You take 4 damage!`);
      } else {
        state.player.hp -= 2;
        pushMessage(`The ${e.name} hits you for 2 damage!`);
      }
    }
    const dx = state.player.x - e.x;
    const dy = state.player.y - e.y;
    if(Math.abs(dx)+Math.abs(dy)===2 && state.rng()<0.1){
      pushMessage(`The ${e.name} spits poison! You are poisoned!`);
      state.player.poison = 5;
    }
  }
  if(state.player.poison > 0){
    state.player.poison--;
    state.player.hp -= 1;
    pushMessage("You suffer 1 poison damage!");
  }
  if(state.player.hp<=0){
    pushMessage("You collapse from your wounds... Game Over.");
  }
  state.turn++;
  draw();
}

// ==== DRAW ====
function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height);
  const W=canvas.width, H=canvas.height;
  ctx.fillStyle="#111"; ctx.fillRect(0,H/2,W,H/2);
  ctx.fillStyle="#333"; ctx.fillRect(0,0,W,H/2);
  const [dx,dy]=dirToDelta(state.player.dir);
  const px=state.player.x, py=state.player.y;
  for(let d=1;d<=3;d++){
    let x=px+dx*d, y=py+dy*d;
    if(state.map[y][x]==="#"){
      ctx.fillStyle="#888";
      let wallHeight=H/(d*1.2);
      ctx.fillRect(W/2-80/d,H/2-wallHeight/2,160/d,wallHeight);
      break;
    }
    const enemy=state.enemies.find(e=>e.x===x&&e.y===y);
    if(enemy){
      ctx.fillStyle="red";
      ctx.beginPath();
      ctx.arc(W/2,H/2,30/d,0,Math.PI*2);
      ctx.fill();
    }
    const item=state.items.find(it=>it.x===x&&it.y===y);
    if(item){
      ctx.fillStyle=item.type==="potion" ? "lime" : "cyan";
      ctx.fillRect(W/2-10/d,H/2-10/d,20/d,20/d);
    }
  }
  document.getElementById("hp-bar").style.width = 
    (100*state.player.hp/state.player.maxHp) + "%";
  document.getElementById("mp-bar").style.width = 
    (100*state.player.mp/state.player.maxMp) + "%";

  const statText =
    `HP: ${state.player.hp}/${state.player.maxHp}\n` +
    `MP: ${state.player.mp}/${state.player.maxMp}\n` +
    `Facing: ${['North','East','South','West'][state.player.dir]}\n` +
    `Turn: ${state.turn}\n` +
    (state.player.poison>0 ? `Poisoned (${state.player.poison} turns left)` : ``);

  document.getElementById("stats").innerText = statText;

  document.getElementById("inventory").innerText =
    `Inventory:\n` +
    `Health Potions: ${state.player.inventory.health} (press 1)\n` +
    `Mana Potions: ${state.player.inventory.mana} (press 2)`;
}

// ==== INPUT ====
document.addEventListener("keydown",e=>{
  const k=e.key;
  if(k==="ArrowUp"||k==="w"){
    const [dx,dy]=dirToDelta(state.player.dir);
    let nx=state.player.x+dx, ny=state.player.y+dy;
    if(state.map[ny][nx]==="."){
      state.player.x=nx; state.player.y=ny;
    }
    const enemy=state.enemies.find(e=>e.x===nx&&e.y===ny);
    if(enemy){
      enemy.hp-=3;
      pushMessage(`You hit the ${enemy.name}!`);
      if(enemy.hp<=0){
        state.enemies=state.enemies.filter(e=>e!==enemy);
        pushMessage(`The ${enemy.name} is slain!`);
      }
    }
    const item=state.items.find(it=>it.x===nx&&it.y===ny);
    if(item){
      if(item.type==="potion"){
        state.player.inventory.health++;
        pushMessage("You picked up a health potion.");
      } else if(item.type==="mana"){
        state.player.inventory.mana++;
        pushMessage("You picked up a mana potion.");
      }
      state.items=state.items.filter(it=>it!==item);
    }
    enemiesTurn();
  }
  else if(k==="ArrowLeft"||k==="a"){
    state.player.dir=(state.player.dir+3)%4; draw();
  }
  else if(k==="ArrowRight"||k==="d"){
    state.player.dir=(state.player.dir+1)%4; draw();
  }
  else if(k==="1"){ useHealthPotion(); }
  else if(k==="2"){ useManaPotion(); }
});

newGame();
</script>
</body>
</html>

